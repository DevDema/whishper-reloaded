name: Docker Build (Parallel Jobs)

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

jobs:
  # Job 1: Build the Frontend Image
  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and cache Frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: false  # Do not push to a registry
          load: false   # Keep the image in the buildx cache, do not load to docker
          tags: whishper-frontend:latest

  # Job 2: Build the Backend Image
  build-backend:
    name: Build Backend Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and cache Backend image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: false
          load: false
          tags: whishper-backend:latest

  # Job 3: Build the Transcription API (GPU) Image
  build-transcription-gpu:
    name: Build Transcription API (GPU)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and cache Transcription API (GPU) image
        uses: docker/build-push-action@v4
        with:
          context: ./transcription-api
          file: ./transcription-api/Dockerfile.gpu
          push: false
          load: false
          tags: whisper-transcription-api-gpu:latest

  # Job 4: Build the Transcription API (CPU) Image
  build-transcription-cpu:
    name: Build Transcription API (CPU)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build and cache Transcription API (CPU) image
        uses: docker/build-push-action@v4
        with:
          context: ./transcription-api
          file: ./transcription-api/Dockerfile.cpu
          push: false
          load: false
          tags: whisper-transcription-api-cpu:latest